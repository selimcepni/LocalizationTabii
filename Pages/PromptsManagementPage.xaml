<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:buttons="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
             xmlns:sfPopup="clr-namespace:Syncfusion.Maui.Toolkit.Popup;assembly=Syncfusion.Maui.Toolkit"
             xmlns:sf="clr-namespace:Syncfusion.Maui.Toolkit.TextInputLayout;assembly=Syncfusion.Maui.Toolkit"
             xmlns:components="clr-namespace:LocalizationTabii.Components"
             x:Class="LocalizationTabii.Pages.PromptsManagementPage"
             Title="Prompt Yönetimi">

    <Grid BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">
        
        <!-- Ana İçerik -->
        <ScrollView Padding="20">
            <StackLayout Spacing="20" WidthRequest="1600" HorizontalOptions="Center">
                
                <!-- Header Bölümü -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                        Stroke="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Padding="24">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">
                        <StackLayout Grid.Column="0" VerticalOptions=
                            "Center" Spacing="4">
                            <Label Text="Prompt Yönetimi" 
                                   Style="{StaticResource Title2}" />
                            <Label Text="AI promptlarınızı kolayca organize edin ve yönetin" 
                                   Style="{StaticResource Body1}" />
                        </StackLayout>
                        
                        <buttons:SfButton Grid.Column="1"
                                          Text="Yeni Prompt"
                                          WidthRequest="140"
                                          HeightRequest="44"
                                          CornerRadius="22"
                                          FontAttributes="Bold"
                                          FontSize="14"
                                          TextColor="White"
                                          Command="{Binding ShowAddPromptCommand}">
                            <buttons:SfButton.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Offset="0.0" Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                    <GradientStop Offset="1.0" Color="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDarkText}}" />
                                </LinearGradientBrush>
                            </buttons:SfButton.Background>
                            <buttons:SfButton.Shadow>
                                <Shadow Brush="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                                        Opacity="0.4" 
                                        Radius="12" 
                                        Offset="0,4"/>
                            </buttons:SfButton.Shadow>
                        </buttons:SfButton>
                    </Grid>
                </Border>
                
                <!-- Arama ve Filtre Kartı -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                        Stroke="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Padding="20">
                    <StackLayout Spacing="16">
                        <Label Text="Arama ve Filtreler" 
                               Style="{StaticResource Title2}" />
                        
                        <!-- Arama Kutusu -->
                        <sf:SfTextInputLayout Hint="Prompt ara... (başlık, içerik)">
                            <Entry Text="{Binding SearchText}" />
                        </sf:SfTextInputLayout>
                        
                        <!-- Filtreler -->
                        <Grid ColumnDefinitions="*" ColumnSpacing="12">
                            <!-- Kategori Filtresi -->
                            <sf:SfTextInputLayout Grid.Column="0" Hint="Kategori">
                                <Picker ItemsSource="{Binding Categories}"
                                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                                        ItemDisplayBinding="{Binding Name}" />
                            </sf:SfTextInputLayout>
                        </Grid>
                    </StackLayout>
                </Border>

                <!-- Loading Indicator -->
                <ActivityIndicator IsVisible="{Binding IsLoading}" 
                                   IsRunning="{Binding IsLoading}"
                                   Color="{AppThemeBinding Light={StaticResource LightPrimaryColor}, Dark={StaticResource DarkPrimaryColor}}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   HeightRequest="60" />

                <!-- Promptlar Listesi -->
                <StackLayout IsVisible="{Binding HasPrompts}" Spacing="12">
                    <!-- Pagination Info ve Sayfa Bilgileri -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16" Margin="0,0,0,8">
                        <Label Grid.Column="0"
                               Text="{Binding PaginationInfo}"
                               Style="{StaticResource Body2}"
                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}"
                               VerticalOptions="Center" />
                        
                        <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalOptions="Center">
                            <Label Text="{Binding CurrentPage, StringFormat='Sayfa {0}'}"
                                   Style="{StaticResource Caption1Strong}"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}" />
                            <Label Text="{Binding TotalPages, StringFormat='/ {0}'}"
                                   Style="{StaticResource Caption1}"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}" />
                        </StackLayout>
                    </Grid>

                    <!-- Prompt Kartları -->
                    <CollectionView ItemsSource="{Binding Prompts}"
                                    BackgroundColor="Transparent"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                                        Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 16"
                                        Padding="20"
                                        Margin="0,0,0,12">

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!-- Header - Title ve Actions -->
                                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="16" Margin="0,0,0,12">
                                            <StackLayout Grid.Column="0" VerticalOptions="Center" Spacing="4">
                                                <Label Text="{Binding Title}" 
                                                       Style="{StaticResource Title3}"
                                                       TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="2" />
                                                       
                                                <StackLayout Orientation="Horizontal" Spacing="12">
                                                    <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightAccentColor}, Dark={StaticResource DarkAccentColor}}"
                                                            Stroke="Transparent"
                                                            StrokeThickness="0"
                                                            StrokeShape="RoundRectangle 12"
                                                            Padding="8,4">
                                                        <Label Text="{Binding Category}"
                                                               Style="{StaticResource Caption1Strong}"
                                                               TextColor="{AppThemeBinding Light={StaticResource LightPrimaryColor}, Dark={StaticResource DarkPrimaryColor}}" />
                                                    </Border>
                                                    
                                                    <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightAccentColor}, Dark={StaticResource DarkAccentColor}}"
                                                            Stroke="Transparent"
                                                            StrokeThickness="0"
                                                            StrokeShape="RoundRectangle 12"
                                                            Padding="8,4">
                                                        <Label Text="{Binding Language}"
                                                               Style="{StaticResource Caption1}"
                                                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}" />
                                                    </Border>
                                                </StackLayout>
                                            </StackLayout>
                                            
                                            <!-- Action Buttons -->
                                            <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalOptions="Center">
                                                <buttons:SfButton Text="Kullan"
                                                                  WidthRequest="70"
                                                                  HeightRequest="32"
                                                                  CornerRadius="16"
                                                                  FontSize="12"
                                                                  FontAttributes="Bold"
                                                                  TextColor="White"
                                                                  Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.UsePromptCommand}"
                                                                  CommandParameter="{Binding}">
                                                    <buttons:SfButton.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                            <GradientStop Offset="0.0" Color="{AppThemeBinding Light={StaticResource SuccessColor}, Dark={StaticResource SuccessColor}}" />
                                                            <GradientStop Offset="1.0" Color="{AppThemeBinding Light={StaticResource SuccessDarkColor}, Dark={StaticResource SuccessDarkColor}}" />
                                                        </LinearGradientBrush>
                                                    </buttons:SfButton.Background>
                                                </buttons:SfButton>
                                            </StackLayout>
                                        </Grid>

                                        <!-- Content Preview -->
                                        <Label Grid.Row="1" 
                                               Text="{Binding Content}"
                                               Style="{StaticResource Body2}"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="3"
                                               Margin="0,0,0,12" />

                                        <!-- Stats -->
                                        <StackLayout Grid.Row="2" Orientation="Horizontal" Spacing="20" Margin="0,0,0,12">
                                            <StackLayout Orientation="Horizontal" Spacing="4">
                                                <Label Text="📊" FontSize="14" />
                                                <Label Text="{Binding UsageCount, StringFormat='{0} kullanım'}"
                                                       Style="{StaticResource Caption1}"
                                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}" />
                                            </StackLayout>
                                            
                                            <StackLayout Orientation="Horizontal" Spacing="4">
                                                <Label Text="📅" FontSize="14" />
                                                <Label Text="{Binding UpdatedAt, StringFormat='{0:dd.MM.yyyy}'}"
                                                       Style="{StaticResource Caption1}"
                                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}" />
                                            </StackLayout>
                                        </StackLayout>

                                        <!-- Action Bar -->
                                        <StackLayout Grid.Row="3" Orientation="Horizontal" Spacing="12">
                                            <buttons:SfButton Text="Düzenle"
                                                              WidthRequest="80"
                                                              HeightRequest="28"
                                                              CornerRadius="14"
                                                              FontSize="11"
                                                              TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                              BackgroundColor="Transparent"
                                                              Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                              StrokeThickness="1"
                                                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShowEditPromptCommand}"
                                                              CommandParameter="{Binding}" />
                                                              
                                            <buttons:SfButton Text="Sil"
                                                              WidthRequest="60"
                                                              HeightRequest="28"
                                                              CornerRadius="14"
                                                              FontSize="11"
                                                              TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                              BackgroundColor="Transparent"
                                                              Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                              StrokeThickness="1"
                                                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShowDeleteConfirmationCommand}"
                                                              CommandParameter="{Binding}" />
                                        </StackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Pagination Controls -->
                    <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                            Stroke="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 16"
                            Padding="20"
                            Margin="0,8,0,0">
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                            <!-- Previous Buttons -->
                            <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <buttons:SfButton Text="⏮"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  FontSize="16"
                                                  TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                  BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                                                  Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                  StrokeThickness="1"
                                                  Command="{Binding GoToFirstPageCommand}"
                                                  IsEnabled="{Binding HasPreviousPage}" />
                                                  
                                <buttons:SfButton Text="◀"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  FontSize="14"
                                                  TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                  BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                                                  Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                  StrokeThickness="1"
                                                  Command="{Binding GoToPreviousPageCommand}"
                                                  IsEnabled="{Binding HasPreviousPage}" />
                            </StackLayout>

                            <!-- Page Info -->
                            <StackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center" Spacing="4">
                                <Label Text="{Binding CurrentPage, StringFormat='Sayfa {0}'}"
                                       Style="{StaticResource Body1Strong}"
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                       HorizontalOptions="Center" />
                                <Label Text="{Binding TotalPages, StringFormat='{0} sayfa'}"
                                       Style="{StaticResource Caption1}"
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}"
                                       HorizontalOptions="Center" />
                            </StackLayout>

                            <!-- Next Buttons -->
                            <StackLayout Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                <buttons:SfButton Text="▶"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  FontSize="14"
                                                  TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                  BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                                                  Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                  StrokeThickness="1"
                                                  Command="{Binding GoToNextPageCommand}"
                                                  IsEnabled="{Binding HasNextPage}" />
                                                  
                                <buttons:SfButton Text="⏭"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  FontSize="16"
                                                  TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                                                  BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                                                  Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                                                  StrokeThickness="1"
                                                  Command="{Binding GoToLastPageCommand}"
                                                  IsEnabled="{Binding HasNextPage}" />
                            </StackLayout>
                        </Grid>
                    </Border>
                </StackLayout>

                <!-- Empty State -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceColor}, Dark={StaticResource DarkSurfaceColor}}"
                        Stroke="{AppThemeBinding Light={StaticResource LightBorderColor}, Dark={StaticResource DarkBorderColor}}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Padding="40"
                        IsVisible="{Binding ShowEmptyState}">
                    <StackLayout HorizontalOptions="Center" Spacing="16">
                        <Label Text="📝"
                               FontSize="64"
                               HorizontalOptions="Center"
                               Opacity="0.6" />
                        <Label Text="Henüz prompt eklenmemiş"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimaryColor}, Dark={StaticResource DarkTextPrimaryColor}}"
                               HorizontalOptions="Center" />
                        <Label Text="İlk prompt'unuzu eklemek için 'Yeni Prompt' butonunu kullanın"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondaryColor}, Dark={StaticResource DarkTextSecondaryColor}}"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                    </StackLayout>
                </Border>
            </StackLayout>
        </ScrollView>
        
        <!-- Popup'lar - MVVM Best Practice -->
        <components:AddPromptPopup x:Name="addPromptPopup" />
        <components:EditPromptPopup x:Name="editPromptPopup" />
        
    </Grid>
</ContentPage>